title: 抽奖场景——并发思考
date: 2016-3-4 00:00:03
categories:  并发控制

tags: [ 并发控制,程序锁使用 ]


---
# 锁类型 & 适用场景 
乐观锁～ 适合，同时刻，低频改写  特点: 更新带比对条件
悲观所～ 适合，同时刻，高频改写  特点: 全程锁
> 性能优化可通过，认领资源（乐观锁），多线程，多进程（负载均衡）
 
# 负载均衡场景下，怎么控制多机器多实例间的程序锁
多实例间的`程序锁`只能控制单实例,跨实例就会失去了锁控制. 怎么办?
>可以加入预分配或动态分配或认领制，让多实例同时处理各自的数据(数据被拆分就不再是共享数据了,所以可以并发处理)


---
# 常见情况
##1.有高并发，担心出现或已出现共享资源边界超出（超额，成负）
* 建议控制: 使用悲观锁
还有一种场景是数据错乱，原因是没有使用数据库锁。
举例： 库存递减处理
不用使用`update tableName set num = newNum where id = ?` (隐患:并发下会出现重复更新)

应该使用`update tableName set num = num-1 where id = ?`    (目的:数据库管理锁)
 
## 2.悲观锁，把多线程控制成了单线程，吞吐量受阻。
如业务的吞吐性能不达标，需要使用多线程资源定量认领（认领是乐观锁），认领了资源的线程虽依然使用悲观锁，但认领资源的多线程可以同时执行，从而提高了吞吐量

* 建议控制: 多线程进行资源定量认领(低频改写,使用乐观锁),各自认领资源的线程使用悲观锁( 高频改写 )
 
## 3.还不够 =》负载均衡， 多机器 ， 多实例


<!-- more -->
